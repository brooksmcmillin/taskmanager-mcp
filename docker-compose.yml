services:
  auth-server:
    build: .
    container_name: taskmanager-auth-server
    command: uv run python -m taskmanager_mcp.auth_server --port 9000 --taskmanager-url ${TASKMANAGER_OAUTH_HOST:-localhost:4321}
    ports:
      - "9000:9000"
    environment:
      - TASKMANAGER_CLIENT_ID=${TASKMANAGER_CLIENT_ID}
      - TASKMANAGER_CLIENT_SECRET=${TASKMANAGER_CLIENT_SECRET}
      - TASKMANAGER_OAUTH_HOST=${TASKMANAGER_OAUTH_HOST:-localhost:4321}
      - MCP_SERVER=http://resource-server:8001
      - MCP_AUTH_SERVER_URL=${MCP_AUTH_SERVER_PUBLIC_URL}
      - DATABASE_URL=${DATABASE_URL:-postgresql://taskmanager:p3LmaMx98qoZ%40RXDNXE@postgres_db:5432/taskmanager}
    env_file:
      - .env
    networks:
      - taskmanager-network
      - shared_network
    restart: unless-stopped

  resource-server:
    build: .
    container_name: taskmanager-resource-server
    command: uv run python -m taskmanager_mcp.server --port 8001 --auth-server http://auth-server:9000 --auth-server-public-url $MCP_AUTH_SERVER_PUBLIC_URL
    ports:
      - "8001:8001"
    environment:
      - TASKMANAGER_CLIENT_ID=${TASKMANAGER_CLIENT_ID}
      - TASKMANAGER_CLIENT_SECRET=${TASKMANAGER_CLIENT_SECRET}
      - MCP_AUTH_SERVER=http://auth-server:9000
      - MCP_SERVER_URL=${MCP_SERVER_URL}
      - MCP_AUTH_SERVER_PUBLIC_URL=${MCP_AUTH_SERVER_PUBLIC_URL}
    env_file:
      - .env
    depends_on:
      - auth-server
    networks:
      - taskmanager-network
    restart: unless-stopped

networks:
  taskmanager-network:
    driver: bridge
  shared_network:
    external: true
